name: Deploy Laravel via ECR

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # === Job 1: ビルドしてECRへ送る ===
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # AWSへの認証 (Secretsに登録した鍵を使います)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # Dockerイメージを作って、ECRにアップロード
      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          # ▼ ここをあなたが決めたリポジトリ名にしています
          ECR_REPOSITORY: laravel-admin-app
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f docker/php/Dockerfile.production ./laravel
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  # === Job 2: EC2で新しいイメージに入れ替える ===
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ap-northeast-1
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          EC2_APP_DIR: ${{ secrets.EC2_APP_DIR }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,AWS_DEFAULT_REGION,AWS_ACCOUNT_ID,EC2_APP_DIR
          script: |
            # 1. AWSへログイン (ECRからダウンロードするため)
            # ※ここで secrets.AWS_ACCOUNT_ID を使います
            aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.ap-northeast-1.amazonaws.com
            
            # 2. アプリのディレクトリへ移動
            cd $EC2_APP_DIR
            
            # 3. 最新のイメージをダウンロード (ここもリポジトリ名を合わせました)
            docker pull $AWS_ACCOUNT_ID.dkr.ecr.ap-northeast-1.amazonaws.com/laravel-admin-app:latest
            
            # 4. コンテナを作り直す
            # (Step3で修正した docker-compose.production.yml が使われます)
            docker compose -f docker-compose.production.yml down
            docker compose -f docker-compose.production.yml up -d
            
            # 5. マイグレーションとキャッシュクリア
            # (Git Pullをしないので、docker内のコードは常に最新です)
            docker compose -f docker-compose.production.yml exec -T php php artisan migrate --force
            docker compose -f docker-compose.production.yml exec -T php php artisan config:clear
            docker compose -f docker-compose.production.yml exec -T php php artisan cache:clear
            docker compose -f docker-compose.production.yml exec -T php php artisan config:cache
            docker compose -f docker-compose.production.yml exec -T php php artisan route:cache
            docker compose -f docker-compose.production.yml exec -T php php artisan view:cache
            echo "=== Sync Assets ==="
            docker compose -f docker-compose.production.yml cp php:/var/www/html/public/. ./laravel/public/